#!/usr/bin/env python

import imaplib
from email.parser import HeaderParser
import time
import re

USR = ''  # your gmail account
PWD = ''  # your gmail password


def show_unread_emails():
    """shows unread emails from the last hour"""
    parser = HeaderParser()

    imap_server = imaplib.IMAP4_SSL('imap.gmail.com', 993)
    imap_server.login(USR, PWD)
    imap_server.select('Inbox')

    th = time.time() - 3600  # search messages from the last hour
    query = '(X-GM-RAW "after:%d is:unread")' % th

    for message_id in imap_server.search(None, query)[1][0].split(" "):
        try:
            response = imap_server.fetch(message_id,
                                         "(BODY[HEADER.FIELDS (SUBJECT FROM)] X-GM-THRID)")
            imap_server.store(message_id, '-FLAGS', '\\Seen')
            id_data = response[1][0][0]
            header_data = response[1][0][1]
            msg = parser.parsestr(header_data)
            thrid = re.compile('X-GM-THRID (\d+)').search(id_data).groups()[0]
            thurl = 'https://mail.google.com/mail/u/0/#inbox/' + '{0:x}'.format(int(thrid))
            print '===================================='
            print thurl
            print msg
        except:
            print "**No new messages**"


if __name__ == '__main__':
    show_unread_emails()
